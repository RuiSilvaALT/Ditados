<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ditado Rítmico</title>

<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0f8ff; }
  h1 { color: #3333aa; }
  #estado { margin: 8px 0 16px; }

  .linha { display: flex; justify-content: center; gap: 15px; margin-top: 12px; flex-wrap: wrap; }
  .celula {
    width: 150px; height: 150px; object-fit: contain; border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    opacity: 0.15; transition: opacity 0.2s, transform 0.2s;
    background: rgba(255,255,255,0.35);
  }
  .ativa { opacity: 1; transform: scale(1.06); }

  button {
    font-size: 18px; padding: 12px 18px; margin: 6px;
    cursor: pointer; border-radius: 10px;
    background-color: #3333aa; color: white; border: none;
  }
  button:hover { background-color: #5555cc; }
  button:disabled { background: #999; cursor: not-allowed; }
</style>
</head>

<body>
<h1>Ditado Rítmico</h1>
<p id="estado">A carregar sons…</p>

<div class="linha">
  <img id="img0" class="celula">
  <img id="img1" class="celula">
  <img id="img2" class="celula">
  <img id="img3" class="celula">
</div>

<br>

<button id="startBtn" onclick="iniciarDitado()" disabled>Iniciar Ditado</button>
<button id="reouvirBtn" onclick="reouvir()" style="display:none;">Ouvir novamente</button>
<button id="revelarBtn" onclick="mostrarResolucao()" style="display:none;">Mostrar resolução</button>

<script>
/* ==========================
   TEMPO / METRÓNOMO
========================== */
const BPM = 65;
const DURACAO_TEMPO = 60 / BPM;
const COUNT_IN = 4;

/* ==========================
   AUDIO
========================== */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

/* ==========================
   CÉLULAS
========================== */
const celulaEspecial = { id:1, img:"imagens/img1.png", som:"sons/som1.mp3", tempos:2 };
const CELULAS_PROIBIDAS_PRIMEIRA = [3,8];

const opcoesNormais = [
  {id:2,img:"imagens/img2.png",som:"sons/som2.mp3",tempos:1},
  {id:3,img:"imagens/img3.png",som:"sons/som3.mp3",tempos:1},
  {id:4,img:"imagens/img4.png",som:"sons/som4.mp3",tempos:1},
  {id:5,img:"imagens/img5.png",som:"sons/som5.mp3",tempos:1},
  {id:6,img:"imagens/img6.png",som:"sons/som6.mp3",tempos:1},
  {id:7,img:"imagens/img7.png",som:"sons/som7.mp3",tempos:1},
  {id:8,img:"imagens/img8.png",som:"sons/som8.mp3",tempos:1},
  {id:9,img:"imagens/img9.png",som:"sons/som9.mp3",tempos:1},
  {id:10,img:"imagens/img10.png",som:"sons/som10.mp3",tempos:1}
];

/* ==========================
   STATE
========================== */
let sequencia=[];
let pronto=false;
let resolucaoMostrada=false;
let agendados=[];
let clickBuffer=null;

const startBtn=document.getElementById("startBtn");
const reouvirBtn=document.getElementById("reouvirBtn");
const revelarBtn=document.getElementById("revelarBtn");
const estado=document.getElementById("estado");

/* ==========================
   LOAD
========================== */
async function carregarSom(ctx,url){
  const r=await fetch(url); const b=await r.arrayBuffer();
  return await ctx.decodeAudioData(b);
}
function criarClick(ctx){
  const sr=ctx.sampleRate,len=sr*0.03;
  const buf=ctx.createBuffer(1,len,sr);
  const d=buf.getChannelData(0);
  for(let i=0;i<len;i++) d[i]=(Math.random()*2-1)*(1-i/len)*0.6;
  return buf;
}
async function carregarTudo(){
  audioCtx=new AudioContext();
  celulaEspecial.buffer=await carregarSom(audioCtx,celulaEspecial.som);
  for(const c of opcoesNormais) c.buffer=await carregarSom(audioCtx,c.som);
  clickBuffer=criarClick(audioCtx);
  pronto=true; estado.textContent="Pronto ✔️"; startBtn.disabled=false;
}
carregarTudo();

/* ==========================
   HELPERS
========================== */
function limparVisual(){ for(let i=0;i<4;i++){ const img=document.getElementById("img"+i); img.src=""; img.classList.remove("ativa"); } }
function parar(){ agendados.forEach(s=>{try{s.stop();}catch{}}); agendados=[]; }
function escolher(lista){ return lista[Math.floor(Math.random()*lista.length)]; }
function tirar(lista){ return lista.splice(Math.floor(Math.random()*lista.length),1)[0]; }

/* ==========================
   GERAR SEQUÊNCIA
========================== */
function gerarSequencia(){
  const especial=Math.random()<0.5;
  const copia=[...opcoesNormais];
  const primeiraPool=copia.filter(c=>!CELULAS_PROIBIDAS_PRIMEIRA.includes(c.id));
  const primeira=escolher(primeiraPool);
  copia.splice(copia.findIndex(x=>x.id===primeira.id),1);

  if(especial){
    const segunda=tirar(copia);
    return [primeira,segunda,celulaEspecial];
  }else{
    return [primeira,tirar(copia),tirar(copia),tirar(copia)];
  }
}

/* ==========================
   TOCAR COM METRÓNOMO CONTÍNUO
========================== */
function tocar(){
  parar();
  if(audioCtx.state==="suspended") audioCtx.resume();

  let t0=audioCtx.currentTime+0.15;
  const totalTempos=COUNT_IN+sequencia.reduce((s,c)=>s+c.tempos,0);

  // metrónomo (do count-in até ao fim)
  for(let i=0;i<totalTempos;i++){
    const c=audioCtx.createBufferSource();
    c.buffer=clickBuffer;
    c.connect(audioCtx.destination);
    c.start(t0+i*DURACAO_TEMPO);
    agendados.push(c);
  }

  // sequência começa após count-in
  let t=t0+COUNT_IN*DURACAO_TEMPO;
  sequencia.forEach(c=>{
    const s=audioCtx.createBufferSource();
    s.buffer=c.buffer;
    s.connect(audioCtx.destination);
    s.start(t);
    agendados.push(s);
    t+=c.tempos*DURACAO_TEMPO;
  });

  const totalMs=(totalTempos*DURACAO_TEMPO+0.2)*1000;
  setTimeout(()=>{ reouvirBtn.style.display="inline-block"; revelarBtn.style.display="inline-block"; startBtn.disabled=false; startBtn.textContent="Iniciar Ditado"; }, totalMs);
}

/* ==========================
   AÇÕES
========================== */
function iniciarDitado(){
  if(!pronto) return;
  parar();
  if(resolucaoMostrada){ limparVisual(); resolucaoMostrada=false; }
  sequencia=gerarSequencia();
  limparVisual();
  reouvirBtn.style.display="none"; revelarBtn.style.display="none";
  startBtn.disabled=true; startBtn.textContent="A tocar…";
  tocar();
}
function reouvir(){ iniciarDitado(); }
function mostrarResolucao(){
  parar(); limparVisual();
  sequencia.forEach((c,i)=>{ const img=document.getElementById("img"+i); img.src=c.img; img.classList.add("ativa"); });
  resolucaoMostrada=true; startBtn.textContent="Novo ditado";
}
</script>

</body>
</html>
