<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ditado Rítmico</title>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
    background: #f0f8ff;
  }
  h1 { color: #3333aa; }

  #estado { margin: 8px 0 16px; }

  .linha {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .celula {
    width: 150px;
    height: 150px;
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    opacity: 0.15;
    transition: opacity 0.2s, transform 0.2s;
    background: rgba(255,255,255,0.35);
  }

  .ativa {
    opacity: 1;
    transform: scale(1.06);
  }

  button {
    font-size: 18px;
    padding: 12px 18px;
    margin: 6px;
    cursor: pointer;
    border-radius: 10px;
    background-color: #3333aa;
    color: white;
    border: none;
  }

  button:hover { background-color: #5555cc; }
  button:disabled { background: #999; cursor: not-allowed; }
</style>
</head>

<body>

<h1>Ditado Rítmico</h1>
<p id="estado">A carregar sons…</p>

<div class="linha">
  <img id="img0" class="celula">
  <img id="img1" class="celula">
  <img id="img2" class="celula">
  <img id="img3" class="celula">
</div>

<br>

<button id="startBtn" onclick="iniciarDitado()" disabled>Iniciar Ditado</button>
<button id="reouvirBtn" onclick="reouvir()" style="display:none;">Ouvir novamente</button>
<button id="revelarBtn" onclick="mostrarResolucao()" style="display:none;">Mostrar resolução</button>

<script>
/* ==========================
   PULSAÇÃO
========================== */
const BPM = 65;
const DURACAO_TEMPO = 60 / BPM;

/* ==========================
   AUDIO
========================== */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

/* ==========================
   CÉLULAS
========================== */
const celulaEspecial = {
  id: 1,
  img: "imagens/img1.png",
  som: "sons/som1.mp3",
  tempos: 2   // única célula que vale 2 tempos
};

const CELULA_PROIBIDA_PRIMEIRA_ID = 3;

const opcoesNormais = [
  { id: 2, img:"imagens/img2.png", som:"sons/som2.mp3", tempos: 1 },
  { id: 3, img:"imagens/img3.png", som:"sons/som3.mp3", tempos: 1 },
  { id: 4, img:"imagens/img4.png", som:"sons/som4.mp3", tempos: 1 },
  { id: 5, img:"imagens/img5.png", som:"sons/som5.mp3", tempos: 1 },
  { id: 6, img:"imagens/img6.png", som:"sons/som6.mp3", tempos: 1 },
  { id: 7, img:"imagens/img7.png", som:"sons/som7.mp3", tempos: 1 },
  { id: 8, img:"imagens/img8.png", som:"sons/som8.mp3", tempos: 1 },
  { id: 9, img:"imagens/img9.png", som:"sons/som9.mp3", tempos: 1 },
  { id: 10, img:"imagens/img10.png", som:"sons/som10.mp3", tempos: 1 }
];

/* ==========================
   STATE
========================== */
let sequencia = [];
let pronto = false;
let resolucaoMostrada = false;
let agendados = [];

const startBtn = document.getElementById("startBtn");
const reouvirBtn = document.getElementById("reouvirBtn");
const revelarBtn = document.getElementById("revelarBtn");
const estado = document.getElementById("estado");

/* ==========================
   LOAD AUDIO
========================== */
async function carregarSom(ctx, url) {
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  return await ctx.decodeAudioData(buf);
}

async function carregarTudo() {
  audioCtx = new AudioContext();

  celulaEspecial.buffer = await carregarSom(audioCtx, celulaEspecial.som);
  for (const c of opcoesNormais) {
    c.buffer = await carregarSom(audioCtx, c.som);
  }

  pronto = true;
  estado.textContent = "Pronto ✔️";
  startBtn.disabled = false;
}

carregarTudo();

/* ==========================
   UTILITÁRIOS
========================== */
function limparVisual() {
  for (let i = 0; i < 4; i++) {
    const img = document.getElementById("img" + i);
    img.src = "";
    img.classList.remove("ativa");
  }
}

function pararAgendados() {
  agendados.forEach(s => { try { s.stop(); } catch(e){} });
  agendados = [];
}

/* ==========================
   GERAR SEQUÊNCIA
========================== */
function gerarSequencia() {
  const especialSai = Math.random() < 0.5;

  if (especialSai) {
    const copia = [...opcoesNormais];
    const primeiraPool = copia.filter(c => c.id !== CELULA_PROIBIDA_PRIMEIRA_ID);
    const primeira = primeiraPool[Math.floor(Math.random() * primeiraPool.length)];
    copia.splice(copia.findIndex(c => c.id === primeira.id), 1);
    const segunda = copia[Math.floor(Math.random() * copia.length)];
    return [primeira, segunda, celulaEspecial];
  } else {
    const copia = [...opcoesNormais];
    const primeiraPool = copia.filter(c => c.id !== CELULA_PROIBIDA_PRIMEIRA_ID);
    const primeira = primeiraPool[Math.floor(Math.random() * primeiraPool.length)];
    copia.splice(copia.findIndex(c => c.id === primeira.id), 1);
    const segunda = copia.splice(Math.floor(Math.random() * copia.length),1)[0];
    const terceira = copia.splice(Math.floor(Math.random() * copia.length),1)[0];
    const quarta = copia.splice(Math.floor(Math.random() * copia.length),1)[0];
    return [primeira, segunda, terceira, quarta];
  }
}

/* ==========================
   TOCAR COM PULSAÇÃO
========================== */
function tocarSequencia() {
  pararAgendados();
  if (audioCtx.state === "suspended") audioCtx.resume();

  let t = audioCtx.currentTime + 0.15;

  sequencia.forEach(c => {
    const src = audioCtx.createBufferSource();
    src.buffer = c.buffer;
    src.connect(audioCtx.destination);
    src.start(t);
    agendados.push(src);
    t += c.tempos * DURACAO_TEMPO;
  });

  const totalTempos = sequencia.reduce((s,c)=>s+c.tempos,0);
  const totalMs = (totalTempos * DURACAO_TEMPO + 0.2) * 1000;

  setTimeout(() => {
    reouvirBtn.style.display = "inline-block";
    revelarBtn.style.display = "inline-block";
  }, totalMs);
}

/* ==========================
   AÇÕES
========================== */
function iniciarDitado() {
  pararAgendados();

  if (resolucaoMostrada) {
    limparVisual();
    resolucaoMostrada = false;
  }

  reouvirBtn.style.display = "none";
  revelarBtn.style.display = "none";

  sequencia = gerarSequencia();
  limparVisual();

  startBtn.textContent = "A tocar…";
  startBtn.disabled = true;

  tocarSequencia();

  const totalTempos = sequencia.reduce((s,c)=>s+c.tempos,0);
  const totalMs = (totalTempos * DURACAO_TEMPO + 0.3) * 1000;

  setTimeout(() => {
    startBtn.disabled = false;
    startBtn.textContent = "Iniciar Ditado";
  }, totalMs);
}

function reouvir() {
  iniciarDitado();
}

function mostrarResolucao() {
  pararAgendados();
  limparVisual();

  sequencia.forEach((c,i)=>{
    const img = document.getElementById("img"+i);
    img.src = c.img;
    img.classList.add("ativa");
  });

  resolucaoMostrada = true;
  startBtn.textContent = "Novo ditado";
}
</script>

</body>
</html>
